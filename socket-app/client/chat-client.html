<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Chat Client</title>
	<script src="react.development.js"></script>
	<script src="react-dom.development.js"></script>
	<script src="babel.min.js"></script>
	<script src="socket.io.js"></script>
	<script type="text/babel">
		{/*
		class ChatClient extends React.Component{
			socket = null;
			state = {
				newMessage : '',
				messages : []
			};

			componentDidMount(){
				this.socket = io('http://localhost:3000');
				console.dir(this.socket);
				this.socket.on('chat message', (receivedMsg) => {
					this.setState({ messages : [...this.state.messages, receivedMsg]})
				});
			}
			componentWillUnmount(){
				this.socket.disconnect();
			}
			onSendMessage = () => {
				this.socket.emit('chat message', this.state.newMessage)
			}
			onNewMessageChange = (evt) =>{
				this.setState({ newMessage : evt.target.value});
			}
			render(){
				return(
					<div>
						<input type="text" onChange={  this.onNewMessageChange }/>
						<input type="button" value="Send" onClick={ this.onSendMessage}/>
						<ol>
							{
								this.state.messages.map(message => <li>{message}</li>)
							}
						</ol>
					</div>
				)
			}
		}*/}
		let { useState, useEffect } = React;

		let createSocketHook = function(url){
				let socket = null;
				if (!socket){
					socket = io(url);
				}
				
			return function(onNewMessageCallback){
				let [ newMessage, setNewMessage ] = useState('');
				useEffect(() => {
				  	socket.on('chat message', (receivedMsg) => {
						onNewMessageCallback(receivedMsg);
					});
				    return () => {
				      socket.removeAllListeners();
				      socket.close();
				    };
				  }, []);

				let sendMessage = () => {
					socket.emit('chat message', newMessage)
				};
				return [setNewMessage, sendMessage];
			}
		}

		let useSocket = createSocketHook('http://localhost:3000');
		let ChatClient = () => {
			let [ messages, addNewMessage ] = useState('');
			let [ setNewMessage, sendMessage ] = useSocket(receivedMessage => {
				addNewMessage(messages + ' - ' + receivedMessage);
			});

			return(
				<div>
					<input type="text" onChange={ evt => setNewMessage(evt.target.value) }/>
					<input type="button" value="Send" onClick={ sendMessage }/>
					<div>{messages}</div>
				</div>
			)

		}
		ReactDOM.render(<ChatClient />,
			document.getElementById('root'));
	</script>
</head>
<body>
	<div id="root"></div>
</body>
</html>